/**
 * Poll Vote Interaction Handler
 * Handles poll voting button clicks
 */

import { InteractionHandler, InteractionHandlerTypes } from '@sapphire/framework';
import type { ButtonInteraction } from 'discord.js';
import {
  ContainerBuilder,
  SectionBuilder,
  TextDisplayBuilder,
  SeparatorBuilder,
  MessageFlags,
} from 'discord.js';
import { pollService } from '../../common/database/client.js';

const EMOJI_NUMBERS = ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'];

export class PollVoteHandler extends InteractionHandler {
  public constructor(ctx: InteractionHandler.LoaderContext, options: InteractionHandler.Options) {
    super(ctx, {
      ...options,
      interactionHandlerType: InteractionHandlerTypes.Button,
    });
  }

  public override parse(interaction: ButtonInteraction) {
    if (!interaction.customId.startsWith('poll_vote_')) return this.none();
    return this.some();
  }

  public override async run(interaction: ButtonInteraction) {
    const optionIndex = parseInt(interaction.customId.replace('poll_vote_', ''));
    const messageId = interaction.message.id;
    const userId = interaction.user.id;

    // Get poll from database
    const poll = await pollService.get(messageId);
    if (!poll) {
      const embed = this.container.embedBuilder.error(
        '„Ç®„É©„Éº',
        'ÊäïÁ•®„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ'
      );
      await interaction.reply({ embeds: [embed], flags: MessageFlags.Ephemeral });
      return;
    }

    if (poll.status === 'closed') {
      const embed = this.container.embedBuilder.warning(
        'Ë≠¶Âëä',
        '„Åì„ÅÆÊäïÁ•®„ÅØÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ'
      );
      await interaction.reply({ embeds: [embed], flags: MessageFlags.Ephemeral });
      return;
    }

    // Record vote
    const result = await pollService.vote(messageId, userId, optionIndex);
    if (!result) {
      const embed = this.container.embedBuilder.error(
        '„Ç®„É©„Éº',
        'ÊäïÁ•®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'
      );
      await interaction.reply({ embeds: [embed], flags: MessageFlags.Ephemeral });
      return;
    }

    // Update poll message with new vote counts
    const options = JSON.parse(poll.options) as string[];
    const { votes } = result;

    // Build header section with question
    const headerSection = new SectionBuilder().addTextDisplayComponents(
      new TextDisplayBuilder().setContent(`# üìä ${poll.question}`)
    );

    // Build separators
    const separator1 = new SeparatorBuilder()
      .setDivider(true)
      .setSpacing(1);

    const separator2 = new SeparatorBuilder()
      .setDivider(true)
      .setSpacing(1);

    // Build info section
    const endsAt = poll.endsAt ? new Date(poll.endsAt) : null;
    const creator = await this.container.client.users.fetch(poll.creatorId).catch(() => null);
    const infoText = endsAt
      ? `‚è∞ **ÊäïÁ•®ÊúüÈôê:** <t:${Math.floor(endsAt.getTime() / 1000)}:R>\nüë§ **‰ΩúÊàêËÄÖ:** ${creator?.tag || 'Unknown'}`
      : `üë§ **‰ΩúÊàêËÄÖ:** ${creator?.tag || 'Unknown'}`;

    const infoSection = new SectionBuilder().addTextDisplayComponents(
      new TextDisplayBuilder().setContent(infoText)
    );

    // Build options section with updated vote counts
    const optionsText = options
      .map((option, index) => {
        const count = votes[index.toString()] || 0;
        return `${EMOJI_NUMBERS[index]} **${option}**: ${count}Á•®`;
      })
      .join('\n');

    const optionsSection = new SectionBuilder().addTextDisplayComponents(
      new TextDisplayBuilder().setContent(optionsText)
    );

    // Build container
    const container = new ContainerBuilder()
      .setAccentColor(this.container.colors.primary)
      .addSectionComponents(headerSection)
      .addSeparatorComponents(separator1)
      .addSectionComponents(infoSection)
      .addSeparatorComponents(separator2)
      .addSectionComponents(optionsSection);

    // Update the message
    await interaction.update({
      components: [container, ...interaction.message.components.slice(1)],
    });
  }
}
